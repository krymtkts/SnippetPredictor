name: Test
description: Setup .NET, install PowerShell modules and run all tests.

inputs:
  codecov_token:
    description: "Codecov token"
    required: true

runs:
  using: composite
  steps:
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: ./global.json
    - name: Install modules from PSGallery
      shell: pwsh
      run: |
        Set-PSResourceRepository PSGallery -Trusted
        Install-PSResource Psake,Pester,PSScriptAnalyzer -Quiet -Reinstall -Scope CurrentUser
        Install-PSResource Microsoft.PowerShell.PlatyPS -Prerelease -Quiet -Reinstall -Scope CurrentUser
    - name: Test release build
      # NOTE: test release build to ensure no error caused by compilation conditions.
      shell: pwsh
      run: |
        Invoke-Psake -taskList Build -parameters @{'Stage'='Release'}
        if (-not $psake.build_success) { exit 1 }
    - name: Execute All Tests
      shell: pwsh
      run: |
        Invoke-Psake -taskList TestAll
        if (-not $psake.build_success) { exit 1 }
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      if: runner.os == 'Linux'
      with:
        files: ./coverage.cobertura.xml
      env:
        CODECOV_TOKEN: ${{ inputs.codecov_token }}
    # NOTE: separate multiple SARIF uploads to add categories. see https://github.blog/changelog/2024-05-06-code-scanning-will-stop-combining-runs-from-a-single-upload/
    - name: Upload SARIF file for main project
      uses: github/codeql-action/upload-sarif@v4
      if: runner.os == 'Linux'
      with:
        sarif_file: analysis/SnippetPredictor-report.sarif
        category: Main
    - name: Upload SARIF file for test project
      uses: github/codeql-action/upload-sarif@v4
      if: runner.os == 'Linux'
      with:
        sarif_file: analysis/SnippetPredictor.Test-report.sarif
        category: Test
